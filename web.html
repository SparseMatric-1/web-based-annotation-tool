<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark">
  <meta name="theme-color" content="#2e7d32">
  <title>ç™»å½• Â· æ£®ç»¿æç®€</title>
  <!-- ç™»å½•é¡µæ ·å¼ï¼ˆåˆ‡æ¢åˆ°åº”ç”¨åä¼šç§»é™¤ï¼‰ -->
  <style id="login-style">
    :root {
      --forest: #2e7d32;      /* ä¸»è‰²ï¼šæ£®ç»¿ */
      --forest-600: #256d2a;  /* æ‚¬åœ/æŒ‰å‹ */
      --forest-700: #1f5e25;  /* æ›´æ·± */
      --bg: #f3f6f3;          /* èƒŒæ™¯æ·¡ç»¿ç° */
      --surface: #ffffff;     /* é¢æ¿ */
      --text: #101510;        /* ä¸»æ–‡å­— */
      --muted: #6b756b;       /* æ¬¡çº§æ–‡å­— */
      --ring: rgba(46, 125, 50, 0.45); /* èšç„¦é«˜äº® */
      --radius: 14px;
      --shadow: 0 10px 30px rgba(0,0,0,0.08), 0 2px 10px rgba(0,0,0,0.04);
      --gap: 14px;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
      color: var(--text);
      background: radial-gradient(1200px 600px at 10% -10%, rgba(46,125,50,0.08), transparent 60%),
                  radial-gradient(800px 400px at 110% 10%, rgba(46,125,50,0.06), transparent 60%),
                  var(--bg);
      display: grid;
      place-items: center;
    }
    .card {
      width: min(92vw, 420px);
      background: var(--surface);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 28px;
      border: 1px solid rgba(46,125,50,0.10);
    }
    .brand { display: flex; align-items: center; gap: 12px; margin-bottom: 8px; }
    .brand svg { flex: none; }
    .brand strong { font-size: 18px; letter-spacing: 0.4px; }
    .muted { color: var(--muted); font-size: 14px; margin: 0 0 18px; }
    h1 { margin: 0 0 4px; font-size: 22px; }
    form { display: grid; gap: var(--gap); }
    label { font-size: 14px; color: var(--muted); display: block; margin-bottom: 6px; }
    .field { display: grid; gap: 6px; }
    .input { width: 100%; height: 44px; padding: 0 12px; border: 1px solid rgba(16,21,16,0.15); border-radius: 10px; background: #fff; color: var(--text); transition: box-shadow .15s ease, border-color .15s ease; }
    .input::placeholder { color: #99a199; }
    .input:focus { outline: none; border-color: var(--forest); box-shadow: 0 0 0 3px var(--ring); }
    /* è°ƒæ•´å¯†ç è¡Œä¸ºç½‘æ ¼å¸ƒå±€ï¼Œä½¿æ˜¾éšæŒ‰é’®åœ¨è¾“å…¥æ¡†å†…å‚ç›´å±…ä¸­ */
    .password-row { position: relative; display: grid; grid-template-columns: 1fr; grid-template-rows: auto 44px; }
    .password-row label { grid-row: 1; }
    .password-row .input { grid-row: 2; padding-right: 72px; }
    .toggle { grid-row: 2; position: relative; right: 8px; top: 0; transform: none; height: 32px; padding: 0 10px; border-radius: 8px; border: 1px solid transparent; background: transparent; color: var(--forest-700); cursor: pointer; font-size: 12px; justify-self: end; align-self: center; z-index: 1; }
    .toggle:hover { background: rgba(46,125,50,0.06); }
    .toggle:focus-visible { outline: none; box-shadow: 0 0 0 3px var(--ring); }
    .row { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
    .check { display: inline-flex; align-items: center; gap: 8px; user-select: none; cursor: pointer; color: var(--muted); font-size: 14px; }
    .check input { width: 16px; height: 16px; accent-color: var(--forest); }
    .btn { height: 46px; border: 0; border-radius: 10px; cursor: pointer; background: var(--forest); color: #fff; font-weight: 600; letter-spacing: .3px; transition: transform .03s ease, filter .15s ease, box-shadow .2s ease; box-shadow: 0 6px 16px rgba(46,125,50,.25); }
    .btn:hover { filter: brightness(0.98); }
    .btn:active { transform: translateY(1px); box-shadow: 0 4px 12px rgba(46,125,50,.22); }
    .btn:focus-visible { outline: none; box-shadow: 0 0 0 3px var(--ring), 0 6px 16px rgba(46,125,50,.25); }
    .links { display: flex; justify-content: space-between; align-items: center; margin-top: 6px; }
    .link { color: var(--forest-700); text-decoration: none; font-size: 14px; }
    .link:hover { text-decoration: underline; }
    footer { text-align: center; margin-top: 18px; color: var(--muted); font-size: 12px; }
    @media (prefers-color-scheme: dark) {
      :root { --bg: #0e120f; --surface: #141a15; --text: #e7eee7; --muted: #a8b2a8; --shadow: none; }
      body { background: radial-gradient(1000px 500px at -10% -10%, rgba(46,125,50,0.18), transparent 60%), var(--bg); }
      .input { background: #0f1410; border-color: rgba(231,238,231,0.14); color: var(--text); }
      .input::placeholder { color: #7e897e; }
      .toggle { color: #cfe7d1; }
      .link { color: #b6e0b8; }
      .card { border-color: rgba(46,125,50,0.20); }
    }
  </style>
  <!-- åº”ç”¨é¡µæ ·å¼ï¼ˆæ¥è‡ª demo2.htmlï¼Œä¿æŒåŸæ ·ï¼‰ -->
  <style id="app-style">
    :root{ --theme:#2e7d32; --theme-weak:#e8f3ea; --ink:#1f2937; --muted:#6b7280; --bg:#f7f8fa; --card:#ffffff; --radius:14px; }
    *{ box-sizing:border-box; } html,body{ height:100%; }
    body{ margin:0; background:var(--bg); color:var(--ink); font:14px/1.6 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif; }
    .topbar{ position:sticky; top:0; z-index:20; display:flex; align-items:center; gap:12px; padding:10px 14px; background:#fff; border-bottom:1px solid #eef2f7; }
    .progress{ margin-left:auto; font-weight:700; color:var(--theme); background:var(--theme-weak); padding:4px 10px; border-radius:999px; }
    .wrap{ display:grid; grid-template-columns:280px minmax(0,1fr); gap:18px; max-width:1500px; margin:0 auto; padding:16px; }
    @media (max-width:900px){ .wrap{ grid-template-columns:1fr; } .sidebar{ order:2; } .main{ order:1; } }
    .sidebar{ background:#fff; border:1px solid #eef2f7; border-radius:var(--radius); padding:12px; position:sticky; top:62px; height:calc(100vh - 78px); overflow:auto; }
    .search{ width:100%; padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px; outline:none; }
    .audio-list{ margin-top:10px; display:flex; flex-direction:column; gap:8px; }
    .audio-item{ border:1px solid #eef2f7; border-radius:12px; padding:8px; display:flex; align-items:center; gap:8px; background:#fff; transition:background .15s ease,border-color .15s ease; }
    /* ç¡®è®¤åï¼šå·¦ä¾§åˆ—è¡¨æ–¹æ¡†å˜ä¸ºâ€œç¡®è®¤ä¿®æ”¹â€æŒ‰é’®åŒæ¬¾ç»¿è‰² */
    .audio-item.confirmed{ background:var(--theme); border-color:var(--theme); }
    .audio-item.confirmed .name{ color:#fff; }
    .audio-item.confirmed .btn-ghost{ background:transparent; color:#fff; border-color:rgba(255,255,255,.9); }
    .audio-item.confirmed .btn-play{ background:#fff; color:var(--theme); }
    .audio-item .name{ flex:1; min-width:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .btn{ border:none; cursor:pointer; border-radius:10px; padding:6px 10px; font-weight:600; }
    .btn-play{ background:var(--theme); color:#fff; }
    .btn-ghost{ background:transparent; color:var(--theme); border:1px solid var(--theme); }
    .main{ display:flex; flex-direction:column; gap:12px; max-width:1000px; }
    .card{ background:var(--card); border:1px solid #eef2f7; border-radius:var(--radius); padding:12px; display:flex; flex-direction:column; gap:10px; }
    .row{ background:#f7faf8; border:1px dashed #dfeae1; border-radius:10px; padding:10px 12px; }
    .row .label{ color:var(--muted); font-size:12px; margin-bottom:4px; }
    .row .text{ white-space:pre-wrap; }
    .badge{ background:var(--theme-weak); color:var(--theme); padding:2px 8px; border-radius:999px; font-weight:700; font-size:12px; margin-right:8px; }
    textarea{ width:100%; min-height:80px; resize:vertical; padding:10px 12px; border-radius:10px; border:1px solid #e5e7eb; outline:none; }
    .bottom{ display:grid; grid-template-columns:110px 1fr; gap:10px; align-items:center; }
    .confirm-btn{ width:100%; height:40px; border:none; border-radius:12px; background:var(--theme); color:#fff; font-weight:800; cursor:pointer; box-shadow:0 6px 12px rgba(46,125,50,.15); }
    .confirm-btn.ghost{ background:transparent; color:var(--theme); border:2px solid var(--theme); }
    .audio-box{ display:flex; align-items:center; gap:8px; border:1px solid #eef2f7; border-radius:10px; padding:8px 10px; background:#fff; }
    .audio-tip{ font-size:12px; color:#9ca3af; }
    .empty{ text-align:center; padding:28px; color:var(--muted); }
    .fab{ position:fixed; right:20px; bottom:20px; z-index:30; background:var(--theme); color:#fff; border:none; border-radius:999px; padding:14px 20px; font-weight:800; cursor:pointer; box-shadow:0 16px 30px rgba(46,125,50,.25); }
    .fab.fab-secondary{ right:120px; background:#256d2a; }
    .toast{ position:fixed; left:50%; bottom:96px; transform:translateX(-50%); background:#111827; color:#fff; padding:10px 14px; border-radius:10px; opacity:0; pointer-events:none; transition:.25s; }
    .toast.show{ opacity:.96; }
  </style>
</head>
<body>
  <!-- ç™»å½•è§†å›¾ï¼šæºè‡ª login.html çš„ä¸»ä½“å†…å®¹ -->
  <div id="login-view">
    <main class="card" role="main">
      <div class="brand" aria-hidden="true">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect width="24" height="24" rx="8" fill="rgba(46,125,50,0.10)"></rect>
          <path d="M18.5 6.5c-5.5 0-9 3.5-9 9 0 0 3.5 0 9-5.5V6.5Z" fill="#2e7d32"></path>
        </svg>
        <strong>æ£®ç»¿</strong>
      </div>
      <h1>æ¬¢è¿ç™»å½•</h1>
      <form id="login-form" action="#" method="post" novalidate>
        <div class="field">
          <label for="username">ç”¨æˆ·å</label>
          <input class="input" id="username" name="username" type="text" placeholder="è¾“å…¥ç”¨æˆ·å" autocomplete="username" required>
        </div>
        <div class="field password-row">
          <label for="password">å¯†ç </label>
          <input class="input" id="password" name="password" type="password" placeholder="è‡³å°‘ 8 ä½" minlength="8" autocomplete="current-password" required>
          <button class="toggle" type="button" id="togglePassword" aria-label="æ˜¾ç¤ºæˆ–éšè—å¯†ç " aria-pressed="false">æ˜¾ç¤º</button>
        </div>
        <div class="row">
          <label class="check"><input type="checkbox" name="remember"> è®°ä½æˆ‘</label>
        </div>
        <button class="btn" type="submit">ç™»å½•</button>
      </form>
      <footer>Â© 2025 SenlÃ¼. ä¿æŒç®€æ´ Â· ä¿æŒä¸“æ³¨</footer>
    </main>
  </div>
  <!-- åº”ç”¨è§†å›¾ï¼šæºè‡ª demo2.html çš„ä¸»ä½“å†…å®¹ï¼Œåˆå§‹éšè— -->
  <div id="app-view" style="display:none">
    <div class="topbar">
      <div class="progress" id="progress">0 / 0 å·²ç¡®è®¤</div>
      <button class="btn btn-ghost" id="logoutBtn" title="é€€å‡ºç™»å½•">é€€å‡º</button>
    </div>
    <div class="wrap">
      <aside class="sidebar">
        <input class="search" id="search" placeholder="æœç´¢éŸ³é¢‘å / å…³é”®å­—â€¦" />
        <div class="audio-list" id="audioList"></div>
      </aside>
      <main class="main" id="main">
        <div class="empty">æ­£åœ¨ä»åç«¯åŠ è½½æ•°æ®â€¦ï¼ˆè‹¥å¤±è´¥å°†å±•ç¤º 30 æ¡æ¼”ç¤ºæ•°æ®ï¼‰</div>
      </main>
    </div>
    <button class="fab fab-secondary" id="nextBtn">â¡ ç»§ç»­</button>
    <button class="fab" id="saveBtn">ğŸ’¾ å­˜å‚¨</button>
    <div class="toast" id="toast">æ­£åœ¨ä¿å­˜åˆ°åç«¯â€¦</div>
  </div>
  <!-- ç™»å½•é¡µäº¤äº’è„šæœ¬ï¼ˆæ¥å…¥åç«¯ç™»å½•æ ¡éªŒï¼‰ -->
  <script>
    // å¯†ç æ˜¾éšåˆ‡æ¢
    (function(){
      const $pwd = document.getElementById('password');
      const $btn = document.getElementById('togglePassword');
      $btn?.addEventListener('click', () => {
        const isHidden = $pwd.type === 'password';
        $pwd.type = isHidden ? 'text' : 'password';
        $btn.textContent = isHidden ? 'éšè—' : 'æ˜¾ç¤º';
        $btn.setAttribute('aria-pressed', String(isHidden));
        $pwd.focus();
      });
    })();
    // ç™»å½•æäº¤ï¼šè°ƒç”¨åç«¯ /api/login æ ¡éªŒé€šè¿‡ååˆ‡æ¢åˆ°åº”ç”¨è§†å›¾
    (function(){
      const form = document.getElementById('login-form');
      form?.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!form.checkValidity()) { form.reportValidity(); return; }
        const API_BASE = (location.protocol === 'file:') ? 'http://127.0.0.1:5000' : '';
        // è°ƒç”¨åç«¯ç™»å½•æ ¡éªŒ
        try {
          const username = document.getElementById('username').value.trim();
          const password = document.getElementById('password').value;
          const resp = await fetch(`${API_BASE}/api/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
          });
          if (!resp.ok) { alert('ç”¨æˆ·åå¯†ç é”™è¯¯'); return; }
        } catch(err) {
          console.error('login error:', err);
          alert('æ— æ³•è¿æ¥åç«¯ï¼Œè¯·ç¡®è®¤ server_mysql.py å·²å¯åŠ¨');
          return;
        }
        // ç™»å½•æˆåŠŸåè®°å½•ç”¨æˆ·åå¹¶åˆ‡æ¢åˆ°åº”ç”¨è§†å›¾
        try { window.__username = document.getElementById('username').value.trim(); sessionStorage.setItem('username', window.__username); } catch(e) {}
        const loginStyle = document.getElementById('login-style');
        if (loginStyle) { window.__loginStyleCSS = loginStyle.textContent || ''; loginStyle.remove(); }
        document.title = 'æ ‡æ³¨å·¥å…· Â· æ£®ç»¿ä¸»é¢˜';
        document.getElementById('login-view').style.display = 'none';
        document.getElementById('app-view').style.display = 'block';
        // åˆ‡æ¢åˆ°åº”ç”¨åï¼ŒæŒ‰å½“å‰ç”¨æˆ·é‡æ–°åŠ è½½æ•°æ®ä»¥æ¢å¤è¿›åº¦
        if (typeof window.__appReloadPage === 'function') {
          window.__appReloadPage(0);
        }
      });
    })();
  </script>
  <!-- é€€å‡ºç™»å½•ï¼šæ¢å¤ç™»å½•æ ·å¼ä¸è§†å›¾ -->
  <script>
    (function(){
      const ensureLoginStyle = () => {
        if (!document.getElementById('login-style')) {
          const st = document.createElement('style'); st.id = 'login-style';
          st.textContent = (window.__loginStyleCSS || '').trim();
          if (!st.textContent) {
            // æç«¯å…œåº•ï¼šè‹¥æ— ç¼“å­˜æ ·å¼ï¼Œä¹Ÿä¸é˜»å¡åŠŸèƒ½
            st.textContent = ':root{--bg:#f3f6f3;} body{margin:0;display:grid;place-items:center;}';
          }
          document.head.appendChild(st);
        }
      };
      const logout = () => {
        ensureLoginStyle();
        document.getElementById('app-view').style.display = 'none';
        document.getElementById('login-view').style.display = 'block';
        document.title = 'ç™»å½• Â· æ£®ç»¿æç®€';
        // é‡ç½®ç™»å½•è¡¨å•çŠ¶æ€
        const form = document.getElementById('login-form'); form?.reset();
        const pwd = document.getElementById('password');
        const tbtn = document.getElementById('togglePassword');
        if (pwd && tbtn) { pwd.type = 'password'; tbtn.textContent = 'æ˜¾ç¤º'; tbtn.setAttribute('aria-pressed','false'); }
      };
      document.getElementById('logoutBtn')?.addEventListener('click', logout);
    })();
  </script>
  <!-- åº”ç”¨é¡µè„šæœ¬ï¼šå¯¹é½ demo2.html çš„äº¤äº’ï¼ˆæ¢å¤å·¦ä¾§æ’­æ”¾/å®šä½ä¸å³ä¾§æ’­æ”¾æ ï¼‰ -->
  <script>
  (() => {
    const API_BASE = (location.protocol === 'file:') ? 'http://127.0.0.1:5000' : '';
    const $ = id => document.getElementById(id);
    const esc = s => String(s??"").replace(/[&<>"']/g, m => ({"&":"&amp;","<":"&lt;","&gt;":">",'"':"&quot;","'":"&#39;"}[m] || m));
    const toast = msg => { const t=$("toast"); t.textContent=msg; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),1200); };
    const state = { items:[], filteredIdx:[], currentIdx: null, page: 0, pageSize: 30 };
    const $main=$("main"), $list=$("audioList"), $progress=$("progress"), $save=$("saveBtn");
    function setProgress(){ const t=state.items.length, ok=state.items.filter(x=>x.confirmed).length; $progress.textContent=`${ok} / ${t} å·²ç¡®è®¤`; }
    function renderList(){
      $list.innerHTML="";
      const kw=$("search").value.trim().toLowerCase();
      const filtered = state.items
        .map((x,i)=>({ i, hit: (x.name+" "+x.inputText+" "+x.fixText).toLowerCase().includes(kw) }))
        .filter(o=>o.hit).map(o=>o.i);
      state.filteredIdx = filtered;
      filtered.forEach(i=>{
        const it = state.items[i];
        const el = document.createElement('div'); el.className = 'audio-item' + (it.confirmed ? ' confirmed' : '');
        const btnPlay = document.createElement('button');
        btnPlay.className = 'btn btn-play';
        btnPlay.textContent = 'æ’­æ”¾';
        btnPlay.onclick = () => {
          state.currentIdx = i;
          renderCards();
          // è‡ªåŠ¨æ’­æ”¾å½“å‰å¡ç‰‡ä¸­çš„éŸ³é¢‘
          setTimeout(() => {
            const au = document.querySelector(`audio[data-audio-idx="${i}"]`);
            if (au) { try { au.play(); } catch(_){} }
          }, 0);
        };
        const name = document.createElement('div'); name.className='name'; name.textContent = `${it.name}`;
        const btnLocate = document.createElement('button');
        btnLocate.className = 'btn btn-ghost';
        btnLocate.textContent = 'å®šä½';
        btnLocate.onclick = () => {
          const card = document.getElementById(`card-${i}`);
          if (card) {
            card.scrollIntoView({ behavior:'smooth', block:'start' });
            // é—ªçƒé«˜äº®
            const old = card.style.boxShadow;
            card.style.boxShadow = '0 0 0 3px var(--theme-weak)';
            setTimeout(()=>{ card.style.boxShadow = old; }, 600);
          }
        };
        el.append(btnPlay, name, btnLocate);
        $list.append(el);
      });
    }
    function renderCards(){
      $main.innerHTML = '';
      state.items.forEach((it, idx) => {
        const card = document.createElement('section'); card.className='card'; card.id = `card-${idx}`;
        const row1 = document.createElement('div'); row1.className='row';
        const lb1 = document.createElement('div'); lb1.className='label'; lb1.textContent = 'åŸå§‹è¯†åˆ«æ–‡æœ¬';
        const tx1 = document.createElement('div'); tx1.className='text'; tx1.innerHTML = `<span class="badge">è¾“å…¥</span>${esc(it.inputText)}`;
        row1.append(lb1, tx1);
        const row2 = document.createElement('div'); row2.className='row';
        const lb2 = document.createElement('div'); lb2.className='label'; lb2.textContent = 'ä¿®è®¢å†…å®¹';
        const ta = document.createElement('textarea'); ta.value = it.fixText || '';
        ta.addEventListener('input', () => { it.fixText = ta.value; it.editing=true; });
        row2.append(lb2, ta);
        const bottom = document.createElement('div'); bottom.className='bottom';
        const btn = document.createElement('button'); btn.className = 'confirm-btn' + (it.confirmed? ' ghost':'');
        btn.textContent = it.confirmed? 'å·²ç¡®è®¤' : 'ç¡®è®¤ä¿®æ”¹';
        btn.onclick = () => { it.confirmed = !it.confirmed; it.editing=false; renderCards(); renderList(); setProgress(); };
        const abox = document.createElement('div'); abox.className='audio-box';
        if (state.currentIdx === idx && it.audio) {
          const au = document.createElement('audio');
          au.setAttribute('controls', '');
          au.dataset.audioIdx = String(idx);
          // è‹¥ä¸ºæœ¬åœ° file åè®®ï¼Œéœ€ä¸ºä»¥ /api/ å¼€å¤´çš„ç›¸å¯¹æ¥å£è¡¥ä¸Š API åŸºå€
          au.src = (it.audio && it.audio.startsWith('/api/')) ? (API_BASE + it.audio) : it.audio;
          au.style.width = '100%';
          abox.append(au);
        } else {
          const tip = document.createElement('div'); tip.className='audio-tip';
          tip.textContent = it.audio ? 'ç‚¹å‡»å·¦ä¾§â€œæ’­æ”¾â€åœ¨æ­¤å¤„æ§åˆ¶éŸ³é¢‘' : 'ï¼ˆæ— éŸ³é¢‘ï¼Œç¤ºä¾‹æ•°æ®ï¼‰';
          abox.append(tip);
        }
        bottom.append(btn,abox);
        card.append(row1,row2,bottom);
        card.style.opacity = (it.confirmed && !it.editing) ? .95 : 1;
        $main.append(card);
      });
    }
    function rebuild(){ renderCards(); renderList(); setProgress(); }
    // ---- åˆ†é¡µåŠ è½½æ•°æ® ----
    async function loadPage(page){
      state.page = page;
      state.currentIdx = null;
      const offset = page * state.pageSize;
      try{
        const uname = (window.__username || (typeof sessionStorage!== 'undefined' ? (sessionStorage.getItem('username')||'') : ''));
        const resp = await fetch(`${API_BASE}/api/items?offset=${offset}&limit=${state.pageSize}&username=${encodeURIComponent(uname)}&hideConfirmed=1`, {headers: {"Accept":"application/json"}});
        if(!resp.ok) throw new Error("bad status");
        const items = await resp.json();
        state.items = (items||[]).map((r,i)=>({
          id: r.id ?? r["id_$oid"] ?? String(offset + i + 1),
          name: r.name ?? (r.audio||`éŸ³é¢‘#${offset + i + 1}`),
          audio: r.audio ?? "",
          inputText: r.inputText ?? "",
          fixText: r.fixText ?? (r.inputText ?? ""),
          confirmed: !!r.confirmed,
          editing: false
        }));
        rebuild();
      }catch(e){
        // å›é€€æ¼”ç¤ºæ•°æ®ï¼ˆ30æ¡ï¼‰
        const items=[]; for(let i=1;i<=state.pageSize;i++){
          const name=`demo-${String(offset + i).padStart(3,"0")}.mp3`;
          const text=`ï¼ˆç¤ºä¾‹ï¼‰è¿™æ˜¯ç¬¬ ${offset + i} æ¡è¯†åˆ«æ–‡æœ¬ã€‚`;
          items.push({ id:String(i), name, audio:"", inputText:text, fixText:text, confirmed: false, editing:false });
        }
        state.items = items; rebuild();
      }
    }
    // ---- ä»…ä¿å­˜åˆ°åç«¯ï¼ˆä¸å†ä¸‹è½½ CSVï¼‰ ----
    async function saveToBackend(){
      const payload = state.items.map(x=>({ id: String(x.id), fixText: x.fixText ?? "", confirmed: !!x.confirmed }));
      try{
        $save.disabled = true; $save.textContent = "â³ æ­£åœ¨ä¿å­˜â€¦";
        const uname = (window.__username || (typeof sessionStorage!== 'undefined' ? (sessionStorage.getItem('username')||'') : ''));
        const resp = await fetch(`${API_BASE}/api/annotations`, { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({ username: uname, items: payload }) });
        if(!resp.ok) throw new Error(await resp.text());
        toast("å·²ä¿å­˜åˆ°åç«¯");
        return true;
      }catch(err){
        console.error("save error:", err);
        toast("ä¿å­˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•");
        return false;
      }finally{
        $save.disabled = false; $save.textContent = "ğŸ’¾ å­˜å‚¨";
      }
    }
    $("saveBtn").onclick = () => {
      const total = state.items.length;
      if (total === 0) { toast("æš‚æ— æ•°æ®å¯ä¿å­˜"); return; }
      const confirmed = state.items.filter(x => x.confirmed).length;
      // éœ€å…¨éƒ¨ç¡®è®¤ï¼ˆé»˜è®¤30æ¡ç¤ºä¾‹æ•°æ®ï¼‰ï¼Œå¦åˆ™ä¸å…è®¸ä¿å­˜
      if (confirmed !== total) { toast("æœ‰æœªç¡®è®¤çš„å†…å®¹"); return; }
      saveToBackend();
    };
    $("search").addEventListener("input", renderList);
    // ç»§ç»­æŒ‰é’®ï¼šä¿å­˜å½“å‰é¡µååŠ è½½ä¸‹ä¸€é¡µ
    $("nextBtn").onclick = async () => {
      const total = state.items.length;
      if (total === 0) { toast("æš‚æ— æ•°æ®"); return; }
      const confirmed = state.items.filter(x => x.confirmed).length;
      if (confirmed !== total) { toast("æœ‰æœªç¡®è®¤çš„å†…å®¹"); return; }
      const ok = await saveToBackend();
      if (!ok) return;
      const nextPage = state.page + 1;
      const preLen = state.items.length;
      await loadPage(nextPage);
      if (state.items.length === 0) {
        // æ²¡æœ‰æ›´å¤šæ•°æ®ï¼Œå›é€€é¡µç 
        state.page = nextPage - 1;
        toast("å·²ç»æ˜¯æœ€åä¸€é¡µ");
      } else {
        toast(`å·²åˆ‡æ¢åˆ°ä¸‹ä¸€é¡µï¼ˆç¬¬ ${nextPage + 1} é¡µï¼‰`);
      }
    };
    window.__appReloadPage = (p = 0) => loadPage(p);
    loadPage(0);
  })();
  </script>

  <script>
    (function(){
      try{
        const u = (typeof sessionStorage !== 'undefined') ? (sessionStorage.getItem('username')||'') : '';
        if(u){
          window.__username = u;
          const loginStyle = document.getElementById('login-style');
          if (loginStyle) { window.__loginStyleCSS = loginStyle.textContent || ''; loginStyle.remove(); }
          document.title = 'æ ‡æ³¨å·¥å…· Â· æ£®ç»¿ä¸»é¢˜';
          document.getElementById('login-view').style.display = 'none';
          document.getElementById('app-view').style.display = 'block';
          if (typeof window.__appReloadPage === 'function') { window.__appReloadPage(0); }
        }
      }catch(e){}
    })();
  </script>

</body>
</html>     
